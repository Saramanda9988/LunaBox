name: Auto Build Pre-release

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'internal/**'
  workflow_dispatch:

jobs:
  build-prerelease:
    name: Build Pre-release
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [amd64]
        mode: [portable, installer]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: 'frontend/pnpm-lock.yaml'

      - name: Setup Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install NSIS
        if: matrix.mode == 'installer'
        run: |
          choco install nsis -y
          echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: pnpm install

      - name: Generate version info
        id: version_info
        run: |
          # è·å–æœ€æ–°tagä½œä¸ºåŸºç¡€ç‰ˆæœ¬
          $LATEST_TAG = git describe --tags --abbrev=0 2>$null
          if (-not $LATEST_TAG) {
            $LATEST_TAG = "v0.0.0"
          }
          $BASE_VERSION = $LATEST_TAG -replace '^v', ''
          
          # è·å–æäº¤ä¿¡æ¯
          $COMMIT = "${{ github.sha }}".Substring(0,7)
          $COMMIT_COUNT = git rev-list --count HEAD
          $BUILD_TIME = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          
          # ç”Ÿæˆé¢„å‘å¸ƒç‰ˆæœ¬å·: åŸºç¡€ç‰ˆæœ¬-dev.æäº¤æ¬¡æ•°+æäº¤hash
          $VERSION = "$BASE_VERSION-dev.$COMMIT_COUNT+$COMMIT"
          
          echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
          echo "BASE_VERSION=$BASE_VERSION" >> $env:GITHUB_OUTPUT
          echo "COMMIT=$COMMIT" >> $env:GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $env:GITHUB_OUTPUT
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $env:GITHUB_OUTPUT
          
          Write-Host "Generated Version: $VERSION"
        shell: pwsh

      - name: Build Portable Version
        if: matrix.mode == 'portable'
        run: |
          $LDFLAGS = "-X 'lunabox/internal/version.Version=${{ steps.version_info.outputs.VERSION }}' -X 'lunabox/internal/version.GitCommit=${{ steps.version_info.outputs.COMMIT }}' -X 'lunabox/internal/version.BuildTime=${{ steps.version_info.outputs.BUILD_TIME }}' -X 'lunabox/internal/version.BuildMode=portable'"
          # Build GUI
          wails build -platform windows/${{ matrix.arch }} -ldflags "$LDFLAGS" -o LunaBox-${{ steps.version_info.outputs.VERSION }}-windows-${{ matrix.arch }}-portable.exe
          
          # Build CLI
          go build -ldflags "$LDFLAGS" -o build/bin/lunacli.exe ./cmd/lunacli
        shell: pwsh

      - name: Build Installer Version
        if: matrix.mode == 'installer'
        run: |
          $LDFLAGS = "-X 'lunabox/internal/version.Version=${{ steps.version_info.outputs.VERSION }}' -X 'lunabox/internal/version.GitCommit=${{ steps.version_info.outputs.COMMIT }}' -X 'lunabox/internal/version.BuildTime=${{ steps.version_info.outputs.BUILD_TIME }}' -X 'lunabox/internal/version.BuildMode=installer'"
          
          # Build CLI first (needed for installer)
          go build -ldflags "$LDFLAGS" -o build/bin/lunacli.exe ./cmd/lunacli
          
          # Build GUI with NSIS
          wails build -platform windows/${{ matrix.arch }} -ldflags "$LDFLAGS" -nsis
        shell: pwsh

      - name: Create portable ZIP
        if: matrix.mode == 'portable'
        run: |
          $PKG_NAME = "LunaBox-${{ steps.version_info.outputs.VERSION }}-windows-${{ matrix.arch }}-portable"
          $PKG_DIR = "build/bin/$PKG_NAME"
          New-Item -ItemType Directory -Force -Path "$PKG_DIR"
          New-Item -ItemType Directory -Force -Path "$PKG_DIR/backups"
          New-Item -ItemType Directory -Force -Path "$PKG_DIR/covers"
          
          Copy-Item "build/bin/$PKG_NAME.exe" -Destination "$PKG_DIR/LunaBox.exe"
          Copy-Item "build/bin/lunacli.exe" -Destination "$PKG_DIR/lunacli.exe"
          
          Compress-Archive -Path "$PKG_DIR" -DestinationPath "$PKG_NAME.zip"
        shell: pwsh

      - name: Rename installer
        if: matrix.mode == 'installer'
        run: |
          Write-Host "Files in build/bin:"
          Get-ChildItem -Path "build/bin" -Filter "*.exe" -Recurse
          
          if (Test-Path "build/bin/lunabox-${{ matrix.arch }}-installer.exe") {
            Move-Item -Path "build/bin/lunabox-${{ matrix.arch }}-installer.exe" -Destination "LunaBox-${{ steps.version_info.outputs.VERSION }}-windows-${{ matrix.arch }}-setup.exe"
          } elseif (Test-Path "build/bin/LunaBox-${{ matrix.arch }}-installer.exe") {
            Move-Item -Path "build/bin/LunaBox-${{ matrix.arch }}-installer.exe" -Destination "LunaBox-${{ steps.version_info.outputs.VERSION }}-windows-${{ matrix.arch }}-setup.exe"
          } else {
            Write-Host "Warning: Installer not found for ${{ matrix.arch }}"
          }
        shell: pwsh

      - name: Upload Portable Artifact
        if: matrix.mode == 'portable'
        uses: actions/upload-artifact@v4
        with:
          name: lunabox-${{ steps.version_info.outputs.VERSION }}-windows-${{ matrix.arch }}-portable
          path: LunaBox-${{ steps.version_info.outputs.VERSION }}-windows-${{ matrix.arch }}-portable.zip

      - name: Upload Installer Artifact
        if: matrix.mode == 'installer'
        uses: actions/upload-artifact@v4
        with:
          name: lunabox-${{ steps.version_info.outputs.VERSION }}-windows-${{ matrix.arch }}-installer
          path: LunaBox-${{ steps.version_info.outputs.VERSION }}-windows-${{ matrix.arch }}-setup.exe

  create-prerelease:
    name: Create Pre-release
    needs: build-prerelease
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version info
        id: version_info
        run: |
          # è·å–æœ€æ–°tagä½œä¸ºåŸºç¡€ç‰ˆæœ¬
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          BASE_VERSION=${LATEST_TAG#v}
          
          # è·å–æäº¤ä¿¡æ¯
          COMMIT=$(echo "${{ github.sha }}" | cut -c1-7)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          
          # ç”Ÿæˆé¢„å‘å¸ƒç‰ˆæœ¬å·
          VERSION="$BASE_VERSION-dev.$COMMIT_COUNT+$COMMIT"
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BASE_VERSION=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "COMMIT=$COMMIT" >> $GITHUB_OUTPUT
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Display structure of downloaded files
        run: ls -R ./artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find ./artifacts -type f \( -name "*.zip" -o -name "*.exe" \) -exec cp {} ./release/ \;
          ls -lh ./release

      - name: Get commit messages
        id: get_commits
        run: |
          # è·å–æœ€è¿‘5ä¸ªæäº¤çš„ä¿¡æ¯
          echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s (%h)" -n 5 >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat << EOF > release_notes.md
          ## ğŸš€ LunaBox Development Build

          **âš ï¸ è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨æ„å»ºçš„å¼€å‘ç‰ˆæœ¬**
          
          ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          
          - **ç‰ˆæœ¬å·**: \`${{ steps.version_info.outputs.VERSION }}\`
          - **åŸºäºç‰ˆæœ¬**: \`${{ steps.version_info.outputs.BASE_VERSION }}\`
          - **æäº¤**: [\`${{ steps.version_info.outputs.COMMIT }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### ğŸ“ æœ€è¿‘æäº¤
          
          ${{ steps.get_commits.outputs.COMMITS }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | \`*-portable.zip\` | ä¾¿æºç‰ˆï¼Œè§£å‹å³ç”¨ï¼Œæ•°æ®å­˜å‚¨åœ¨ç¨‹åºç›®å½• |
          | \`*-setup.exe\` | å®‰è£…ç‰ˆï¼Œæ ‡å‡†å®‰è£…ç¨‹åºï¼Œæ•°æ®å­˜å‚¨åœ¨ %APPDATA%\\\\LunaBox |
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          
          - æ­¤ç‰ˆæœ¬ä¸º**å¼€å‘æµ‹è¯•ç‰ˆæœ¬**ï¼Œå¯èƒ½å­˜åœ¨æœªçŸ¥é—®é¢˜
          - æ‚¨å¯ä»¥ç”¨äºæµ‹è¯•æœ€æ–°åŠŸèƒ½ï¼Œå»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä½¿ç”¨ï¼Œåšå¥½æ•°æ®å¤‡ä»½
          - å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆ
          - ç¨³å®šç‰ˆæœ¬è¯·ä½¿ç”¨å¸¦ç‰ˆæœ¬å·æ ‡ç­¾çš„æ­£å¼å‘å¸ƒç‰ˆ
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          
          - [æŸ¥çœ‹å®Œæ•´æäº¤å†å²](https://github.com/${{ github.repository }}/commits/master)
          - [æŠ¥å‘Šé—®é¢˜](https://github.com/${{ github.repository }}/issues/new)
          - [æŸ¥çœ‹æ­£å¼å‘å¸ƒç‰ˆ](https://github.com/${{ github.repository }}/releases)
          EOF

          cat release_notes.md

      - name: Delete old pre-release
        run: |
          # åˆ é™¤æ—§çš„ dev-latest æ ‡ç­¾å’Œrelease
          gh release delete dev-latest --yes || true
          git push origin :refs/tags/dev-latest || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create new tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f dev-latest
          git push -f origin dev-latest

      - name: Create Pre-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dev-latest
          name: "å¼€å‘ç‰ˆ - ${{ steps.version_info.outputs.VERSION }}"
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
