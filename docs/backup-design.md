## 备份系统设计（DuckDB + 云备份）

> **本地为主，OSS 为时间线备份仓库（Time-based Backup）**  
> 模式：Backup + Restore，而不是 Sync。

当前假设为 **单客户端 + 单 OSS** 的典型桌面场景：

- 大部分用户只有一台活跃设备，对应一个云端备份空间（bucket 下的 user 目录）。
- 暂不考虑「同一 userId 多台设备同时写入」的复杂冲突场景，后续如有需求再扩展。

---

## 1. 目标与非目标

**目标**

- 提供可靠的本地 + 云端备份能力，防止 DuckDB 数据库和游戏存档丢失。
- 支持按时间线查看和恢复历史版本（DB 与单个游戏存档）。
- 在不显著影响游玩体验的前提下，实现自动/半自动备份。

**非目标**

- 不做实时数据同步，不保证多端强一致性。
- 不做复杂的合并/重放逻辑，恢复永远是「替换为某个时间点的完整快照」。

---

## 2. 用户与安全模型

### 2.1 用户标识（user-id）

- 当用户开启云备份功能时：
   - 在本地设置：**显示昵称（可选）** + **备份密码（必填）**。
   - 客户端生成一个全局唯一的 `user-id`（例如 备份密码做hash），仅用于 OSS 路径标识：

      ```text
      oss://lunabox-backup/v1/{user-id}/...
      ```

- `user-id` 存储在本地配置文件中（例如 appconf.json / 专门的 user_profile 表），不暴露在 UI 上，避免被用户误删/修改。

### 2.2 备份密码与端到端加密（可选）

- 备份密码只在本地使用，不以明文上传到云端。主要用途：
   - 通过 KDF（如 PBKDF2 / Argon2，具体实现细节以后在技术文档中定义）推导出对称密钥。
   - 使用该密钥对 DuckDB 备份文件和游戏存档压缩包进行加密（例如 AES-GCM）。
- 云端仅存放 **密文文件**，即使 OSS 提供方（如七牛云 / S3 兼容对象存储）也无法直接读取内容。
- 如果用户忘记备份密码，将无法解密云端历史备份，这是端到端加密的「可用性 vs 安全性」权衡，需要在 UI 中明确提示。

> 注：本设计文档只定义「是否加密、加密在什么时候做」，具体加密算法与密钥管理细节可在后续安全设计文档中展开。

### 2.3 OSS（以七牛云 / S3 兼容为例）

- 备份模块只依赖「S3 兼容 API」抽象：
   - 必要配置：`access_key`、`secret_key`、`bucket`、`region`、`endpoint`。
   - 通过官方 SDK 或签名 HTTP 请求上传/下载对象。
- 应用内只关心「对象的 Key 与内容」，不绑定具体厂商实现，方便未来更换 OSS 提供方。

---

## 3. 备份对象与云端结构

### 3.1 DuckDB 文件（元数据 / 游玩时间）

当前核心数据库使用 **DuckDB**，以单一 `.duckdb` 文件为主（路径由应用配置确定）。

**策略：整体快照 + 版本化**

- 每次触发备份：
   1. 暂停写入 / 短锁当前 DuckDB 连接。
   2. 执行 `CHECKPOINT`（或 DuckDB 推荐的安全快照操作）。
   3. 复制 DuckDB 文件到临时目录（`temp`）。
   4. 如果启用加密：先在本地对该临时文件进行加密，生成 `*.duckdb.enc`。
   5. 上传到 OSS。
- 云端保留多个历史版本，永远 **不做合并、不做增量重放**，恢复即为「替换为某个时间点的完整文件」。

**云端目录结构（DuckDB）**

```text
oss://lunabox-backup/
└─ v1/
    └─ {user-id}/
         └─ db/
             ├─ latest.duckdb[.enc]
             └─ history/
                  ├─ 2025-12-17T20-01-00.duckdb[.enc]
                  ├─ 2025-12-10T21-30-00.duckdb[.enc]
```

- `latest.duckdb[.enc]`：最新版本，方便一键恢复。
- `history/`：按 ISO8601-like 时间命名的历史版本，用于回滚与防止误操作。
- 历史保留策略（可配置）：
   - 按数量：默认保留最近 N 份（例如 20 份），超出后按时间自动删除最旧的。
   - 或按时间：保留最近 M 天内的版本。

### 3.2 游戏存档（文件夹压缩包）

这是更典型的「备份而非同步」场景：不做细粒度 diff，只保留完整快照。

**策略**

- 每个游戏一个备份单元，按 `{game-id}` 进行分组。
- 整个存档目录 → 压缩为 `zip` 或 `tar.zst` 等格式（具体实现可后续确定）。
- 命名规则：`{timestamp}.{ext}`，时间戳与 DB 保持一致格式。
- 上传前如果启用加密，则对压缩包进行本地加密，生成 `*.zip.enc` / `*.tar.zst.enc`。
- 支持按游戏配置保留最近 N 份，自动清理旧版本。

**云端目录结构（游戏存档）**

```text
oss://lunabox-backup/
└─ v1/
    └─ {user-id}/
         └─ saves/
             └─ {game-id}/
                  ├─ latest.tar.zst[.enc]
                  ├─ 2025-12-17T19-40-00.tar.zst[.enc]
                  ├─ 2025-12-15T22-10-00.tar.zst[.enc]
```

- `latest.*`：可选的快捷引用，指向最新备份（例如通过复制一份或使用特殊命名）。
- 历史文件：用于在游戏详情页展示备份时间线，并支持选择性恢复。

---

## 4. 触发策略与执行流程

### 4.1 启动阶段（可见性检查）

启动流程建议：

```text
启动应用
↓
打开本地 DuckDB
↓
后台任务：
   - ping OSS（检查凭证与网络）
   - 查询 {user-id}/db/latest.duckdb[.enc] 是否存在
   - 读取 backup_state.json（本地记录）
↓
仅在 UI 中展示状态：
   “上次云备份：2 天前” 或 “尚未进行云备份”
```

- 启动阶段 **只做状态检查，不做任何上传/下载/解密操作**，避免影响启动性能与可用性。

### 4.2 备份触发点

**主动触发**

- 用户在设置页或统计页点击「立即备份」。

**被动触发**（可配置开关与阈值）：

- 某个游戏退出后（捕捉到游玩 session 结束事件）。
- 总游玩时间自上次备份以来变化 ≥ X 分钟（例如 30 分钟）。
- 监控到存档目录的 mtime / 文件变更事件（可选，视平台支持情况）。

> 对于 DuckDB 和大体量存档，建议被动触发逻辑默认在后台执行，并提供「备份进行中」的轻量提示，而不是阻塞 UI。

### 4.3 一次完整备份流程

以「主动触发完整备份」为例：

```text
1. 准备阶段
    - 读取当前配置（user-id、加密开关、OSS 凭证等）

2. DB 备份
    - 暂停重要写入 / 短锁
    - DuckDB CHECKPOINT
    - 复制 DB 文件到 temp
    - （可选）本地加密 → 生成 .duckdb.enc
    - 上传到 OSS：db/history/{timestamp}.duckdb[.enc]
    - 更新 db/latest.duckdb[.enc]

3. 游戏存档备份（可并发）
    - 对需要备份的游戏（全部 / 近期游玩）进行遍历
    - 对每个游戏：
       - 打包存档目录 → {timestamp}.tar.zst
       - （可选）本地加密 → .tar.zst.enc
       - 上传到 saves/{game-id}/{timestamp}.tar.zst[.enc]
       - 更新 saves/{game-id}/latest.tar.zst[.enc]
       - 按保留策略清理超出的历史版本

4. 状态更新
    - 本地更新 backup_state.json：
       - last_backup_time
       - last_backup_result（success / partial-fail / fail）
       - 最近一次各 game-id 的备份时间

5. UI 反馈
    - 显示「备份完成」或「部分失败（X 个游戏存档备份失败）」
```

---

## 5. 恢复流程

### 5.1 DB 恢复

```text
用户在设置页选择「恢复数据库」
↓
展示云端 db/history/ 列表（时间线）
↓
用户选择某个时间点
↓
下载对应 .duckdb[.enc]
↓
（如果加密）本地解密
↓
备份当前本地 DB → local_backup/{timestamp}_before_restore.duckdb
↓
用下载文件覆盖本地 DB
↓
提示用户重启 App
```

- 恢复前务必做一次「本地备份」，防止误操作导致不可逆。
- 恢复操作应要求用户进行二次确认，并清晰展示将要回退到的时间点。

### 5.2 存档恢复

```text
打开某个游戏详情页
↓
进入「备份历史」tab
↓
列出 saves/{game-id}/ 下的时间线
↓
用户选择某个时间点
↓
下载对应压缩包 [.enc]
↓
（如果加密）本地解密
↓
备份当前存档目录 → local_backup/{game-id}/{timestamp}_before_restore/
↓
解压到目标存档目录（覆盖模式）
↓
提示恢复成功，并可选择「打开存档目录」
```

---

## 6. 状态管理与 UI 建议

### 6.1 本地状态文件 backup_state.json

建议记录：

- `last_backup_time`：最近一次整体备份时间。
- `last_backup_result`：success / partial-fail / fail。
- `last_db_backup_time`：最近一次 DB 备份时间。
- `per_game_last_backup_time`：`{ [game-id]: time }`。
- `last_error_message`（可选）：最近一次错误简要信息，便于在 UI 中展示。

### 6.2 UI 展示点

- 设置页 / 主页顶部：
   - 「上次云备份：xx 天前」
   - 「立即备份」按钮
- 游戏详情页：
   - 「备份历史」列表（时间、大小、是否成功标记）
   - 「恢复到该版本」操作入口
- 错误提示：
   - 备份失败时提供非打扰式 toast + 设置页中的详细原因查看。

---

## 7. MVP 范围与后续迭代

### 7.1 MVP 第一阶段

- 支持：
   - 手动「立即备份」（DuckDB + 最近游玩的若干个游戏存档）。
   - DuckDB 快照上传 + 基础历史版本管理（固定保留 N 份）。
   - 单游戏存档的打包上传与简单恢复。
   - 七牛云 / 其他 S3 兼容 OSS 的基础上传/下载对接（不加密或仅简单加密）。
- UI：
   - 设置页显示上次备份时间 + 立即备份按钮。
   - 游戏详情页展示简单的备份时间线。

### 7.2 后续可迭代方向

- 引入完整的端到端加密方案（备份密码 → KDF → 对称密钥）。
- 增加更智能的自动触发策略与节流机制（如夜间静默备份）。
- 更细致的空间管理与配额提示（例如估算云端占用）。
- 支持基础的「多设备」场景（简单规则：最新上传覆盖 latest，用户自行挑选历史版本做恢复）。

---

本设计文档聚焦于 **DuckDB + S3 兼容 OSS（例如七牛云）** 的备份/恢复流程，强调「本地为主、云端容灾、简单可靠」的原则，为后续具体实现与安全设计留出扩展空间。